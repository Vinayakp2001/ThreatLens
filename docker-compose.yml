version: '3.8'

services:
  # ThreatLens Backend v2.0.0
  threatlens-backend:
    build: .
    ports:
      - "8000:8000"
    environment:
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - DEBUG=false
      - LOG_LEVEL=INFO
      
      # Storage Configuration
      - STORAGE_BASE_PATH=/app/storage
      - DATABASE_PATH=/app/storage/threat_modeling.db
      - REPOS_STORAGE_PATH=/app/storage/repos
      - DOCS_STORAGE_PATH=/app/storage/docs
      - EMBEDDINGS_STORAGE_PATH=/app/storage/embeddings
      
      # Analysis Configuration
      - MAX_CONCURRENT_ANALYSES=5
      - ANALYSIS_TIMEOUT_MINUTES=10
      - MAX_REPO_SIZE_MB=100
      
      # LLM Configuration (uncomment and configure as needed)
      # - LLM_PROVIDER=openai
      # - OPENAI_API_KEY=your-openai-api-key-here
      # - OPENAI_MODEL=gpt-4
      
      # Alternative LLM Providers
      # - LLM_PROVIDER=anthropic
      # - ANTHROPIC_API_KEY=your-anthropic-api-key-here
      # - ANTHROPIC_MODEL=claude-3-sonnet-20240229
      
      # - LLM_PROVIDER=google
      # - GOOGLE_API_KEY=your-google-api-key-here
      # - GOOGLE_MODEL=gemini-1.5-pro
      
      # GitHub Integration (for PR analysis)
      # - GITHUB_TOKEN=your-github-token-here
      # - GITHUB_REQUESTS_PER_HOUR=5000
      # - GITHUB_REQUESTS_PER_MINUTE=100
      
      # GPU Configuration (if available)
      - ENABLE_GPU_ACCELERATION=false
      - USE_GPU_FOR_FAISS=false
      
      # Security Configuration
      - ENABLE_LOCAL_REPOS=true
      - ALLOWED_REPO_HOSTS=github.com,gitlab.com,bitbucket.org
      
      # Monitoring
      - ENABLE_METRICS=true
      - HEALTH_CHECK_INTERVAL_SECONDS=60
      
    volumes:
      # Persistent storage for analysis results and models
      - ./storage:/app/storage
      # Configuration files
      - ./config:/app/config
      # Optional: Mount local repositories for analysis
      # - ./repos:/app/repos:ro
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Optional: Frontend service (if you want to serve the frontend)
  # threatlens-frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - VITE_API_BASE_URL=http://localhost:8000
  #   depends_on:
  #     - threatlens-backend
  #   restart: unless-stopped

  # Optional: Reverse proxy with SSL termination
  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - threatlens-backend
  #     - threatlens-frontend
  #   restart: unless-stopped

  # Optional: Monitoring with Prometheus and Grafana
  # prometheus:
  #   image: prom/prometheus:latest
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/etc/prometheus/console_libraries'
  #     - '--web.console.templates=/etc/prometheus/consoles'
  #     - '--web.enable-lifecycle'
  #   restart: unless-stopped

  # grafana:
  #   image: grafana/grafana:latest
  #   ports:
  #     - "3001:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_INSTALL_PLUGINS=grafana-piechart-panel
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #     - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
  #     - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
  #   depends_on:
  #     - prometheus
  #   restart: unless-stopped

# Optional: Named volumes for persistent data
# volumes:
#   prometheus-data:
#   grafana-data:

# Optional: Custom network
# networks:
#   threatlens:
#     driver: bridge